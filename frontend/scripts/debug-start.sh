#!/bin/bash

/**
 * IWMS æ™ºèƒ½æ–‡ä»¶ç®¡ç†è§£å†³æ–¹æ¡ˆ - è°ƒè¯•å¯åŠ¨è„šæœ¬
 * 
 * æœ¬è„šæœ¬ç”¨äºè¯Šæ–­å’Œå¯åŠ¨ IWMS åº”ç”¨ï¼Œè´Ÿè´£ï¼š
 * - æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒï¼ˆNode.jsã€npm ç‰ˆæœ¬ï¼‰
 * - æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ
 * - éªŒè¯é¡¹ç›®ä¾èµ–å®‰è£…çŠ¶æ€
 * - æ¸…ç†æ„å»ºæ–‡ä»¶
 * - ä½¿ç”¨å¤‡ç”¨å¯åŠ¨æ–¹å¼å¯åŠ¨åº”ç”¨
 * 
 * å½“ä¸»å¯åŠ¨æ–¹å¼å‡ºç°é—®é¢˜æ—¶ï¼Œä½¿ç”¨æ­¤è„šæœ¬è¿›è¡Œè¯Šæ–­å’Œå¤‡ç”¨å¯åŠ¨
 * 
 * @author IWMS Team
 * @version 1.0.0
 * @usage ./debug-start.sh
 */

echo "=== IWMS è°ƒè¯•å¯åŠ¨è„šæœ¬ ==="
echo "æœ¬è„šæœ¬å°†å¸®åŠ©æ‚¨è¯Šæ–­å¯åŠ¨é—®é¢˜å¹¶æä¾›å¤‡ç”¨å¯åŠ¨æ–¹å¼"
echo ""

# æ£€æŸ¥ Node.js ç‰ˆæœ¬
# ç¡®ä¿ Node.js ç‰ˆæœ¬å…¼å®¹æ€§
echo "ğŸ” æ£€æŸ¥ Node.js ç¯å¢ƒ..."
echo "Node.js ç‰ˆæœ¬:"
node --version

# æ£€æŸ¥ npm ç‰ˆæœ¬
echo ""
echo "npm ç‰ˆæœ¬:"
npm --version

# æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ
# ç¡®ä¿å¼€å‘æœåŠ¡å™¨ç«¯å£ 5173 æœªè¢«å…¶ä»–è¿›ç¨‹å ç”¨
echo ""
echo "ğŸ” æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ..."
echo "æ£€æŸ¥ç«¯å£ 5173 å ç”¨æƒ…å†µ:"
if lsof -i :5173 > /dev/null 2>&1; then
    echo "âš ï¸  ç«¯å£ 5173 å·²è¢«å ç”¨ï¼Œå¯èƒ½å½±å“å¼€å‘æœåŠ¡å™¨å¯åŠ¨"
    lsof -i :5173
else
    echo "âœ… ç«¯å£ 5173 æœªè¢«å ç”¨"
fi

# æ£€æŸ¥é¡¹ç›®ä¾èµ–çŠ¶æ€
echo ""
echo "ğŸ” æ£€æŸ¥é¡¹ç›®ä¾èµ–çŠ¶æ€..."
if [ -d "node_modules" ]; then
    echo "âœ… node_modules ç›®å½•å­˜åœ¨"
    echo "æ£€æŸ¥å…³é”®ä¾èµ–:"
    
    # æ£€æŸ¥å…³é”®ä¾èµ–æ˜¯å¦å·²å®‰è£…
    if ls node_modules | grep -E "(electron|vite)" > /dev/null 2>&1; then
        echo "âœ… æ‰¾åˆ°å…³é”®ä¾èµ–åŒ…"
        ls node_modules | grep -E "(electron|vite)" | head -5
    else
        echo "âŒ æœªæ‰¾åˆ°å…³é”®ä¾èµ–åŒ…"
    fi
else
    echo "âŒ node_modules ç›®å½•ä¸å­˜åœ¨"
    echo "è¯·å…ˆè¿è¡Œ npm install å®‰è£…ä¾èµ–"
fi

# æ£€æŸ¥ package.json æ–‡ä»¶
echo ""
echo "ğŸ” æ£€æŸ¥é¡¹ç›®é…ç½®æ–‡ä»¶..."
if [ -f "package.json" ]; then
    echo "âœ… package.json æ–‡ä»¶å­˜åœ¨"
    echo "é¡¹ç›®åç§°: $(grep '"name"' package.json | cut -d'"' -f4)"
    echo "é¡¹ç›®ç‰ˆæœ¬: $(grep '"version"' package.json | cut -d'"' -f4)"
else
    echo "âŒ package.json æ–‡ä»¶ä¸å­˜åœ¨"
    echo "å½“å‰ç›®å½•å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ Node.js é¡¹ç›®"
    exit 1
fi

# æ¸…ç†æ„å»ºæ–‡ä»¶
echo ""
echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶..."
echo "åˆ é™¤ dist å’Œ dist-electron ç›®å½•..."
rm -rf dist dist-electron

# æ£€æŸ¥æ¸…ç†æ“ä½œç»“æœ
if [ $? -eq 0 ]; then
    echo "âœ… æ¸…ç†å®Œæˆ"
else
    echo "âš ï¸  æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
fi

# å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆä½¿ç”¨å¤‡ç”¨æ–¹å¼ï¼‰
echo ""
echo "ğŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼..."
echo "ä½¿ç”¨å¤‡ç”¨å¯åŠ¨æ–¹å¼ (concurrently + wait-on)..."
echo "è¿™ç§æ–¹å¼æ›´ç¨³å®šï¼Œé€‚åˆè°ƒè¯•ç¯å¢ƒ"
echo "=========================================="
echo ""

# ä½¿ç”¨å¤‡ç”¨çš„å¯åŠ¨æ–¹å¼
# è¿™ä¼šå…ˆå¯åŠ¨ Vite å¼€å‘æœåŠ¡å™¨ï¼Œç­‰å¾…å°±ç»ªåå†å¯åŠ¨ Electron
npm run electron:dev:fallback
