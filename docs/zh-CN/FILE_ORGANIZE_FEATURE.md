# IWMS 文件整理排序功能

## 🎯 功能概述

文件整理排序功能是对同一组（同base）的图片文件进行重命名与排序规范化，消除断号与错号，保证幂等（重复执行不再变化）。

## 📋 核心概念

### **术语定义**
- **base**：不含序号与扩展名的主体，如 A-1、B-3
- **主图**：文件名形如 `base.ext`（无括号序号）
- **从图**：文件名形如 `base (n).ext`，n ∈ ℕ⁺
- **组**：同一 base 的主图与从图集合

### **支持范围**
- **扩展名**（不区分大小写）：jpg、jpeg、png、tif、tiff、webp
- **大小写与空格**保持原样（除去算法需要的解析）
- **仅处理匹配模式的文件**；不匹配者跳过

## 🔧 技术实现

### **文件名解析正则**
```
^(?P<base>.+?)\s?(?:\((?P<idx>\d+)\))?\.(?P<ext>jpg|jpeg|png|tif|tiff|webp)$
```

- `idx` 为空 → 主图；有值 → 从图
- 匹配采用不区分大小写模式

### **核心业务规则**

#### **配置项**
- `primaryNoIndex: boolean`（对应"主图无序号"选项）

#### **模式 A：primaryNoIndex = true（主图无序号）**
1. 若组内已有主图：保留主图文件名为 `base.ext` 不变
2. 若组内无主图：将最小序号的从图提升为主图，重命名为 `base.ext`
3. 组内其余从图按原序号升序压缩为连续(1..k)：`base (1).ext`, `base (2).ext`, …
4. 幂等保证：再次执行不再改动

#### **模式 B：primaryNoIndex = false（主图也编号）**
1. 组内将所有文件统一重排为连续序列 (1..k)：
   - 若存在主图 `base.ext`，按顺序将其视为第一张 → `base (1).ext`
   - 其余从图按原序号升序依次编号为 (2..k)
   - 若无主图，则从图按原序号升序统一编号 (1..k)
2. 幂等保证：再次执行不再改动

## 🎨 用户界面

### **文件整理选项**
- **主图无序号**：主图保持 base.ext 格式，从图编号为 base (1).ext
- **主图也编号**：所有文件统一编号为 base (1).ext, base (2).ext...
- **启用文件整理**：控制是否启用整理功能
- **仅预览**：预览重命名计划而不执行

### **操作按钮**
- **预览整理**：预览重命名计划，显示详细信息
- **开始整理**：执行文件重命名操作

## 📊 功能特性

### **智能文件识别**
- 自动识别主图和从图
- 支持多种图片格式
- 跳过不匹配的文件

### **分组处理**
- 按base自动分组
- 组内智能排序
- 自然排序（数值感知）

### **重命名策略**
- 两阶段重命名避免冲突
- 临时文件名使用UUID
- 错误恢复机制

### **幂等性保证**
- 重复执行不再变化
- 状态一致性检查
- 安全的重命名操作

## 🔍 使用示例

### **输入文件（同一文件夹）**
```
A-1.JPG, A-1 (1).JPG, A-1 (2).JPG, A-1 (7).JPG
B-3 (2).JPG, B-3 (4).JPG, B-3 (5).JPG
```

### **模式 A：主图无序号**
- **A 组**：主图已存在 → 保留 A-1.JPG；从图 (1),(2),(7) → 压缩为 (1),(2),(3)
  - A-1 (7).JPG → A-1 (3).JPG（其余两张名不变）
- **B 组**：无主图 → (2) 提升为主图 B-3.JPG；其余 (4),(5) → (1),(2)
  - B-3 (2).JPG → B-3.JPG
  - B-3 (4).JPG → B-3 (1).JPG
  - B-3 (5).JPG → B-3 (2).JPG

**结果集合**：
```
A-1.JPG, A-1 (1).JPG, A-1 (2).JPG, A-1 (3).JPG
B-3.JPG, B-3 (1).JPG, B-3 (2).JPG
```

### **模式 B：主图也编号**
- **A 组**：[A-1.JPG, A-1 (1), A-1 (2), A-1 (7)] → 重排为 (1..4)
  - A-1.JPG → A-1 (1).JPG
  - A-1 (1).JPG → A-1 (2).JPG
  - A-1 (2).JPG → A-1 (3).JPG
  - A-1 (7).JPG → A-1 (4).JPG
- **B 组**：[(2),(4),(5)] → (1..3)
  - B-3 (2).JPG → B-3 (1).JPG
  - B-3 (4).JPG → B-3 (2).JPG
  - B-3 (5).JPG → B-3 (3).JPG

**结果集合**：
```
A-1 (1).JPG, A-1 (2).JPG, A-1 (3).JPG, A-1 (4).JPG
B-3 (1).JPG, B-3 (2).JPG, B-3 (3).JPG
```

## 🛡️ 安全机制

### **冲突规避策略**
采用两阶段重命名：
1. 先将所有待改名文件重命名为唯一过渡名（如追加 `.__tmp__{uuid}`）
2. 再批量从过渡名改为目标名，确保无同名覆盖/失败

### **错误处理**
- 文件访问权限错误
- 文件不存在错误
- 重命名失败恢复
- 用户友好的错误提示

### **性能优化**
- 时间复杂度：O(N log N)（以组内排序为主）
- 异步文件操作
- 批量处理优化
- 内存使用优化

## 📁 文件结构

### **核心模块**
- `frontend/electron/utils/fileOrganizer.js` - 文件整理核心逻辑
- `frontend/src/views/FileOrganize.vue` - 用户界面
- `frontend/electron/main.js` - IPC处理器
- `frontend/electron/preload.js` - API暴露

### **测试脚本**
- `frontend/scripts/test-file-organize.js` - 功能测试

## 🚀 使用方法

### **1. 选择文件夹**
```
整理排序页面 → 选择文件夹 → 点击"选择文件夹"按钮
```

### **2. 配置整理选项**
- 选择整理模式（主图无序号/主图也编号）
- 启用文件整理功能
- 选择是否仅预览

### **3. 预览整理计划**
- 点击"预览整理"按钮
- 查看重命名计划详情
- 确认操作无误

### **4. 执行整理**
- 点击"开始整理"按钮
- 确认操作警告
- 等待处理完成

## 📈 测试结果

### **功能测试**
- ✅ 文件名解析正确
- ✅ 文件分组准确
- ✅ 重命名计划生成正确
- ✅ 预览功能正常
- ✅ 幂等性保证

### **性能测试**
- ✅ 处理速度：O(N log N)
- ✅ 内存使用：优化
- ✅ 错误处理：完善

## 🔮 未来计划

### **功能扩展**
- 支持更多文件格式
- 自定义重命名规则
- 批量文件夹处理
- 历史记录和撤销

### **性能优化**
- 并行处理优化
- 缓存机制
- 增量处理

### **用户体验**
- 拖拽排序
- 实时预览
- 进度详情
- 操作日志

---

**IWMS 智能文件管理解决方案** - 让文件整理更智能、更高效！
