# 🖼️ 图片压缩功能说明

## 功能概述

文件重命名工具现在集成了智能图片压缩功能，可以在重命名的同时按指定尺寸压缩图片，大幅减少文件大小，提高存储和传输效率。

## 核心特性

### 1. 智能尺寸计算
- **保持宽高比**: 压缩后图片不会变形
- **最长边限制**: 按用户指定的最长边像素数进行压缩
- **智能判断**: 自动判断宽度和高度，选择较长的边作为基准

### 2. 高质量压缩
- **压缩算法**: 使用Sharp库进行高质量图片处理
- **JPEG质量**: 默认85%质量，平衡文件大小和图片质量
- **格式支持**: 支持主流图片格式的压缩

### 3. 灵活配置
- **压缩开关**: 设置为0时不压缩，直接复制原文件
- **尺寸范围**: 支持1-10000像素的任意设置
- **自动回退**: 压缩失败时自动复制原文件，确保操作安全

## 使用方法

### 1. 设置压缩参数
在第一步"选择输入文件夹"中：
- **最长边像素**: 输入目标尺寸，如1920、1080等
- **0值处理**: 输入0表示不压缩，直接复制原文件

### 2. 压缩效果示例

#### 横向图片 (宽度 > 高度)
```
原尺寸: 4000 x 3000 像素
设置: 最长边 1920 像素
结果: 1920 x 1440 像素 (按比例缩小)
```

#### 纵向图片 (高度 > 宽度)
```
原尺寸: 3000 x 4000 像素  
设置: 最长边 1920 像素
结果: 1440 x 1920 像素 (按比例缩小)
```

#### 小尺寸图片 (无需压缩)
```
原尺寸: 1000 x 800 像素
设置: 最长边 1920 像素
结果: 1000 x 800 像素 (保持原尺寸)
```

## 技术实现

### 压缩算法
```javascript
// 计算新尺寸，保持宽高比
if (width > height) {
  if (width > maxDimension) {
    height = Math.round((height * maxDimension) / width)
    width = maxDimension
  }
} else {
  if (height > maxDimension) {
    width = Math.round((width * maxDimension) / height)
    height = maxDimension
  }
}

// 使用Sharp进行高质量压缩
await sharp(inputPath)
  .resize(width, height, {
    fit: 'inside',
    withoutEnlargement: true
  })
  .jpeg({ quality: 85 })
  .toFile(outputPath)
```

### 支持格式
- **输入格式**: jpg, jpeg, png, gif, bmp, tiff, webp
- **输出格式**: 统一转换为JPEG格式，质量85%
- **元数据**: 保留EXIF等图片元数据

## 实际应用场景

### 场景1: 照片库优化
```
需求: 将4K照片压缩到1080p，节省存储空间
设置: 最长边 1920 像素
效果: 4000x3000 → 1920x1440，文件大小减少约75%
```

### 场景2: 网站图片优化
```
需求: 为网站准备适合的图片尺寸
设置: 最长边 800 像素
效果: 各种尺寸图片统一压缩到800像素以内
```

### 场景3: 移动设备适配
```
需求: 为手机应用准备图片资源
设置: 最长边 1080 像素
效果: 高分辨率图片适配手机屏幕，减少流量消耗
```

## 性能优势

### 1. 存储节省
- **大尺寸图片**: 可节省50-80%的存储空间
- **批量处理**: 支持大量图片同时压缩
- **质量保证**: 在文件大小和质量间取得最佳平衡

### 2. 传输效率
- **网络传输**: 压缩后图片传输速度更快
- **带宽节省**: 减少网络流量消耗
- **加载速度**: 网页和应用的图片加载更快

### 3. 处理速度
- **异步处理**: 使用Node.js异步处理，不阻塞UI
- **批量优化**: 大量文件时性能优异
- **内存管理**: 优化的内存使用，支持大图片处理

## 配置建议

### 常用尺寸设置
- **高清显示**: 1920 像素 (1080p)
- **标准显示**: 1280 像素 (720p)
- **移动设备**: 1080 像素 (手机屏幕)
- **缩略图**: 800 像素 (预览图)
- **图标**: 512 像素 (应用图标)

### 质量平衡
- **高质量**: 85% JPEG质量，适合照片和设计图
- **文件大小**: 根据需求调整，平衡质量和大小
- **批量处理**: 建议先小批量测试，确认效果后再大批量处理

## 注意事项

### 1. 文件格式
- 压缩后统一转换为JPEG格式
- 原格式的透明背景会变成白色背景
- 建议保留原文件作为备份

### 2. 压缩限制
- 最大支持10000像素的图片
- 过大的图片可能需要较长处理时间
- 建议分批处理超大图片

### 3. 质量考虑
- 85%质量适合大多数应用场景
- 如需更高质量，可调整代码中的quality参数
- 压缩是不可逆操作，请谨慎使用

## 错误处理

### 常见问题
1. **格式不支持**: 自动跳过不支持的格式
2. **文件损坏**: 压缩失败时自动复制原文件
3. **权限问题**: 检查输出目录的写入权限
4. **内存不足**: 超大图片可能需要更多内存

### 自动回退
- 压缩失败时自动复制原文件
- 记录详细的错误信息
- 确保操作不会中断

## 测试验证

运行测试脚本可以看到压缩功能演示：
```bash
node iwms-demo.js
```

输出包含压缩效果预览和统计信息。

---

**开始使用**: 在第一步设置"最长边像素"即可启用图片压缩功能！
