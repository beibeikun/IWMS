# 按前缀分文件夹功能说明

## 概述

"按前缀分文件夹"是文件整理排序模块的新增功能，能够在执行文件重命名后，自动按文件名前缀创建子文件夹并将相关文件移动到对应文件夹中。

## 功能特性

### 🎯 核心功能
- **前缀解析**: 自动从文件名中提取前缀，剔除编号后缀
- **智能分组**: 将具有相同前缀的文件分组到同一文件夹
- **文件移动**: 自动创建目标文件夹并移动文件
- **冲突处理**: 支持多种冲突处理策略

### 📱 配置选项
- **按前缀分文件夹**: 开启/关闭功能
- **递归模式**: 是否处理子目录中的文件
- **冲突处理策略**: 跳过/覆盖/重命名
- **目录名清洗**: 替换非法字符
- **大小写敏感**: 是否区分前缀大小写
- **生成移动日志**: 记录所有移动操作

## 技术实现

### 前缀提取算法
使用正则表达式 `^(?P<prefix>.+?)(?:\s*\(\d+\))?$` 提取前缀：

```javascript
// 示例
"A-1.JPG" → 前缀: "A-1"
"A-1 (1).JPG" → 前缀: "A-1"
"Foo Bar-1 (123).PNG" → 前缀: "Foo Bar-1"
"Test File.PNG" → 前缀: "Test File"
```

### 目录名清洗
自动替换非法路径字符：
- `/` → `_`
- `\` → `_`
- `:` → `_`
- `*` → `_`
- `?` → `_`
- `"` → `_`
- `<` → `_`
- `>` → `_`
- `|` → `_`

### 冲突处理策略
1. **keep**: 跳过已存在的文件
2. **overwrite**: 覆盖目标文件
3. **rename**: 生成不冲突的新文件名

## 使用流程

### 1. 配置选项
在文件整理界面中：
1. 勾选"按前缀分文件夹"
2. 选择是否启用递归模式
3. 选择冲突处理策略
4. 选择是否清洗目录名
5. 选择是否大小写敏感
6. 选择是否生成移动日志

### 2. 执行顺序
1. **文件重命名**: 执行现有的重命名逻辑
2. **前缀分组**: 按文件名前缀分组
3. **目录创建**: 创建目标文件夹
4. **文件移动**: 移动文件到对应文件夹
5. **日志记录**: 生成移动操作日志

### 3. 输出结果
```
输入文件:
  A-1.JPG, A-1 (1).JPG, A-1 (2).JPG
  B-3 (1).JPG, B-3 (2).JPG

输出结构:
  /A-1/
    A-1.JPG
    A-1 (1).JPG
    A-1 (2).JPG
  /B-3/
    B-3 (1).JPG
    B-3 (2).JPG
```

## 配置参数详解

### 基本配置
```javascript
{
  groupByPrefix: true,           // 启用按前缀分文件夹
  recursive: false,              // 是否递归处理子目录
  conflictPolicy: 'keep',        // 冲突处理策略
  sanitizeFolderName: true,      // 是否清洗目录名
  caseSensitivePrefix: false,    // 前缀是否大小写敏感
  logMoveCsv: true,              // 是否生成移动日志
  allowedExtensions: ['.jpg', '.jpeg', '.png', '.heic', '.tif', '.tiff', '.gif'],
  maxFolderNameLength: 100       // 目录名最大长度
}
```

### 冲突处理策略
- **keep**: 当目标位置已存在同名文件时，跳过移动操作
- **overwrite**: 覆盖目标文件（谨慎使用）
- **rename**: 自动重命名冲突文件，格式：`name (1).ext`, `name (2).ext`...

## 测试用例

### 基本测试
1. **A-1.JPG, A-1 (1).JPG** → 均入 `/A-1/`
2. **A-0008 (12).png** → 前缀 `A-0008`
3. **Foo (bar).jpg** → 前缀 `Foo (bar)`（括号不在尾部编号位）
4. **X-1(2).jpg** → 识别编号 `(2)`，前缀 `X-1`

### 边界情况
1. **同名冲突**: 验证 keep/overwrite/rename 策略
2. **大小写合并**: `a-1.jpg` 与 `A-1 (1).jpg` → 同一 `/A-1/`
3. **非法字符**: `A:1 (1).jpg` → 目录 `A_1`
4. **空前缀**: 空文件名 → 目录 `__UNCLASSIFIED__`

## 性能特点

### 优化策略
1. **幂等操作**: 重复执行不产生二次嵌套
2. **批量处理**: 一次性处理所有文件
3. **错误隔离**: 单个文件失败不影响整体处理
4. **日志记录**: 完整的操作记录，支持回滚

### 内存使用
- 文件列表: O(n)
- 分组映射: O(n)
- 目录创建: O(unique_prefixes)
- 总体复杂度: O(n)

## 错误处理

### 常见错误
1. **文件不存在**: 跳过并记录错误
2. **权限不足**: 记录错误并继续处理
3. **磁盘空间不足**: 停止处理并报告错误
4. **路径过长**: 按清洗策略处理

### 错误恢复
- 生成详细的错误日志
- 支持部分成功的情况
- 提供回滚操作指南

## 移动日志

### CSV格式
```csv
source_path,dest_path,status,timestamp,error
/path/to/source.jpg,/path/to/dest/folder/source.jpg,moved,2024-01-01T12:00:00Z,
/path/to/failed.jpg,,failed,2024-01-01T12:00:01Z,权限不足
```

### 日志字段
- **source_path**: 源文件路径
- **dest_path**: 目标文件路径
- **status**: 操作状态（moved/skipped/failed）
- **timestamp**: 操作时间戳
- **error**: 错误信息（如果有）

## 兼容性

### 支持的文件类型
- JPG/JPEG
- PNG
- HEIC
- TIFF/TIF
- GIF

### 操作系统支持
- ✅ Windows
- ✅ macOS
- ✅ Linux

### 文件系统限制
- 路径长度限制
- 特殊字符处理
- 权限要求

## 最佳实践

### 使用建议
1. **备份重要文件**: 在执行前备份重要数据
2. **测试环境**: 先在测试目录中验证功能
3. **冲突策略**: 根据实际需求选择合适的冲突处理策略
4. **日志保留**: 保留移动日志以便追踪和回滚

### 注意事项
1. **文件锁定**: 确保文件未被其他程序占用
2. **权限检查**: 确保有足够的读写权限
3. **磁盘空间**: 确保有足够的磁盘空间
4. **路径长度**: 注意操作系统的路径长度限制

## 故障排除

### 常见问题
1. **文件移动失败**: 检查文件权限和磁盘空间
2. **目录创建失败**: 检查目录权限和路径合法性
3. **前缀提取错误**: 检查文件名格式是否符合预期
4. **日志生成失败**: 检查目录写入权限

### 调试方法
1. 查看控制台错误信息
2. 检查移动日志文件
3. 验证文件路径和权限
4. 使用测试脚本验证功能

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持基本的前缀分组功能
- 支持多种冲突处理策略
- 支持目录名清洗
- 支持移动日志生成

## 相关文件

- **前端组件**: `frontend/src/views/FileOrganize.vue`
- **核心逻辑**: `frontend/electron/utils/prefixGrouper.js`
- **文件整理器**: `frontend/electron/utils/fileOrganizer.js`
- **测试脚本**: `frontend/scripts/test-prefix-grouping.js`
- **主进程**: `frontend/electron/main.js`

## 技术支持

如果在使用过程中遇到问题，请：
1. 查看控制台错误信息
2. 检查移动日志文件
3. 运行测试脚本验证功能
4. 提交详细的bug报告
